generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  approver
  publisher
}

enum RunStatus {
  draft
  running
  completed
  failed
}

enum ArtifactStatus {
  draft
  review
  approved
  published
  rejected
}

enum ApprovalDecision {
  approved
  rejected
  needs_changes
}

enum AgentExecStatus {
  pending
  running
  completed
  failed
}

enum PublishJobStatus {
  pending
  running
  partial
  completed
  failed
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String
  image        String?
  passwordHash String?    @map("password_hash")
  role         Role       @default(publisher)
  createdAt    DateTime   @default(now()) @map("created_at")
  lastLoginAt  DateTime?  @map("last_login_at")

  runs              Run[]
  approvals         Approval[]
  publishLogs       PublishLog[]
  assets            Asset[]
  agentExecutions   AgentExecution[]
  publishJobs       PublishJob[]
  integrations      Integration[]
  agentJobs         AgentJob[]
  canvaAssets       CanvaAsset[]
  videoAssets       VideoAsset[]

  @@map("users")
}

model Workspace {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now()) @map("created_at")

  projects  Project[]

  @@map("workspaces")
}

model Project {
  id                 String    @id @default(cuid())
  workspaceId        String    @map("workspace_id")
  name               String
  slug               String
  targetRegistryKey  String    @map("target_registry_key")
  targetRegistryKeys String[]  @default([]) @map("target_registry_keys")
  createdAt          DateTime  @default(now()) @map("created_at")

  workspace         Workspace @relation(fields: [workspaceId], references: [id])
  runs              Run[]
  assets            Asset[]

  @@unique([workspaceId, slug])
  @@map("projects")
}

model Run {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  workflowKey     String    @map("workflow_key")
  status          RunStatus @default(draft)
  createdByUserId String    @map("created_by_user_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  project           Project          @relation(fields: [projectId], references: [id])
  createdBy         User             @relation(fields: [createdByUserId], references: [id])
  artifacts         Artifact[]
  assets            Asset[]
  agentExecutions   AgentExecution[]
  runSteps          RunStep[]
  socialApproval    SocialApproval?

  @@index([projectId])
  @@map("runs")
}

model Asset {
  id              String   @id @default(cuid())
  runId           String?  @map("run_id")
  projectId       String   @map("project_id")
  scope           String   @default("run") // "run" | "project"
  filename        String
  mimeType        String   @map("mime_type")
  size            Int
  storagePath     String   @map("storage_path")
  tags            String[] @default([])
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  description     String?

  run             Run?     @relation(fields: [runId], references: [id])
  project         Project  @relation(fields: [projectId], references: [id])
  createdBy       User     @relation(fields: [createdByUserId], references: [id])
  artifactAssets  ArtifactAsset[]

  @@index([runId])
  @@index([projectId, scope])
  @@map("assets")
}

model Artifact {
  id        String         @id @default(cuid())
  runId     String         @map("run_id")
  type      String
  target    Json           @default("{}")
  status    ArtifactStatus @default(draft)
  title     String         @default("")
  content   String         @default("") @db.Text
  metadata  Json           @default("{}")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt     @map("updated_at")

  run             Run          @relation(fields: [runId], references: [id])
  approvals       Approval[]
  publishLogs     PublishLog[]
  artifactAssets  ArtifactAsset[]
  publishJobs     PublishJob[]
  canvaAssets     CanvaAsset[]
  videoAssets     VideoAsset[]

  @@index([runId])
  @@index([type])
  @@map("artifacts")
}

model Approval {
  id         String           @id @default(cuid())
  artifactId String           @map("artifact_id")
  userId     String           @map("user_id")
  decision   ApprovalDecision
  notes      String           @default("")
  createdAt  DateTime         @default(now()) @map("created_at")

  artifact   Artifact         @relation(fields: [artifactId], references: [id])
  user       User             @relation(fields: [userId], references: [id])

  @@map("approvals")
}

model PublishLog {
  id          String   @id @default(cuid())
  artifactId  String   @map("artifact_id")
  userId      String   @map("user_id")
  destination String
  result      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  artifact    Artifact @relation(fields: [artifactId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([artifactId])
  @@map("publish_logs")
}

model ArtifactAsset {
  id         String   @id @default(cuid())
  artifactId String   @map("artifact_id")
  assetId    String   @map("asset_id")
  placement  String   @default("below")
  alignment  String?
  size       String?
  intent     String   @default("section")
  order      Int      @default(0)
  alt        String   @default("")
  caption    String?
  createdAt  DateTime @default(now()) @map("created_at")

  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, artifactId])
  @@index([artifactId])
  @@index([assetId])
  @@map("artifact_assets")
}

model PublishJob {
  id               String           @id @default(cuid())
  artifactId       String           @map("artifact_id")
  brand            String           // "bestlife"
  selectedChannels String[]         @map("selected_channels")
  directChannels   String[]         @map("direct_channels")
  assistChannels   String[]         @map("assist_channels")
  status           PublishJobStatus @default(pending)
  channelResults   Json             @default("{}") @map("channel_results")
  assistPackPath   String?          @map("assist_pack_path")
  dryRun           Boolean          @default(false) @map("dry_run")
  createdByUserId  String           @map("created_by_user_id")
  createdAt        DateTime         @default(now()) @map("created_at")

  artifact         Artifact         @relation(fields: [artifactId], references: [id])
  createdBy        User             @relation(fields: [createdByUserId], references: [id])

  @@index([artifactId])
  @@map("publish_jobs")
}

model AgentExecution {
  id              String          @id @default(cuid())
  runId           String          @map("run_id")
  agentKey        String          @map("agent_key")
  status          AgentExecStatus @default(pending)
  inputs          Json            @default("{}")
  inputFiles      Json            @default("[]")
  output          String          @default("") @db.Text
  outputMeta      Json            @default("{}")
  error           String?         @db.Text
  startedAt       DateTime?       @map("started_at")
  completedAt     DateTime?       @map("completed_at")
  durationMs      Int?            @map("duration_ms")
  parentExecId    String?         @map("parent_exec_id")
  createdByUserId String          @map("created_by_user_id")
  createdAt       DateTime        @default(now()) @map("created_at")

  run          Run              @relation(fields: [runId], references: [id])
  createdBy    User             @relation(fields: [createdByUserId], references: [id])
  parentExec   AgentExecution?  @relation("ExecLineage", fields: [parentExecId], references: [id])
  childExecs   AgentExecution[] @relation("ExecLineage")
  runStep      RunStep?

  @@index([runId])
  @@index([agentKey])
  @@index([parentExecId])
  @@map("agent_executions")
}

// ─── Per-step agent output storage ───────────────────────────────────────────

model RunStep {
  id                 String   @id @default(cuid())
  runId              String   @map("run_id")
  step               String   // agentKey: strategist|marketing-compiler|editor|...
  agentExecutionId   String?  @unique @map("agent_execution_id")
  status             String   @default("pending") // ok|invalid|error|pending
  markdownOutput     String?  @map("markdown_output") @db.Text
  jsonPayload        Json     @default("{}") @map("json_payload")
  validationErrors   String[] @default([]) @map("validation_errors")
  validationWarnings String[] @default([]) @map("validation_warnings")
  inputStepId        String?  @map("input_step_id")
  hash               String?  // sha256[:16] of markdownOutput for diffing
  createdAt          DateTime @default(now()) @map("created_at")

  run            Run             @relation(fields: [runId], references: [id])
  agentExecution AgentExecution? @relation(fields: [agentExecutionId], references: [id])
  inputStep      RunStep?        @relation("StepChain", fields: [inputStepId], references: [id])
  outputSteps    RunStep[]       @relation("StepChain")

  @@index([runId])
  @@index([step])
  @@map("run_steps")
}

// ─── Integrations (OAuth providers) ─────────────────────────────────────────

model Integration {
  id                String    @id @default(cuid())
  provider          String    @unique              // 'canva'
  accessToken       String    @map("access_token")
  refreshToken      String?   @map("refresh_token")
  expiresAt         DateTime? @map("expires_at")
  connectedByUserId String    @map("connected_by_user_id")
  scopes            String[]  @default([])
  meta              Json      @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  connectedBy  User @relation(fields: [connectedByUserId], references: [id])

  @@map("integrations")
}

// ─── Generic agent job tracker ───────────────────────────────────────────────

model AgentJob {
  id              String   @id @default(cuid())
  type            String                        // 'canva_export'
  status          String   @default("pending")  // pending|running|completed|failed
  input           Json     @default("{}")
  output          Json     @default("{}")
  error           String?
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  createdBy  User @relation(fields: [createdByUserId], references: [id])

  @@index([type, status])
  @@map("agent_jobs")
}

// ─── Video assets generated by marketing-video-producer ──────────────────────

model VideoAsset {
  id              String   @id @default(cuid())
  artifactId      String   @map("artifact_id")
  agentJobId      String?  @map("agent_job_id")
  brand           String                          // 'llif' | 'bestlife'
  variantId       String   @map("variant_id")
  aspectRatio     String   @map("aspect_ratio")  // '9:16' | '16:9' | '1:1'
  durationSeconds Int      @map("duration_seconds")
  storagePath     String   @map("storage_path")  // relative to UPLOAD_DIR
  wpUrl           String?  @map("wp_url")
  wpMediaId       Int?     @map("wp_media_id")
  wpSite          String?  @map("wp_site")
  xaiJobId        String?  @map("xai_job_id")
  mimeType        String   @default("video/mp4") @map("mime_type")
  meta            Json     @default("{}")
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  artifact   Artifact @relation(fields: [artifactId], references: [id])
  createdBy  User     @relation(fields: [createdByUserId], references: [id])

  @@index([artifactId])
  @@map("video_assets")
}

// ─── Canva-generated assets linked to artifacts ──────────────────────────────

model CanvaAsset {
  id              String   @id @default(cuid())
  artifactId      String   @map("artifact_id")
  agentJobId      String?  @map("agent_job_id")
  type            String   @default("image")
  provider        String   @default("canva")
  wpSite          String   @map("wp_site")          // 'llif' | 'bestlife'
  wpMediaId       Int      @map("wp_media_id")
  wpUrl           String   @map("wp_url")
  meta            Json     @default("{}")
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  artifact   Artifact @relation(fields: [artifactId], references: [id])
  createdBy  User     @relation(fields: [createdByUserId], references: [id])

  @@index([artifactId])
  @@map("canva_assets")
}

// ─── Social preview approval state (run-level, per-channel) ──────────────────

model SocialApproval {
  id        String   @id @default(cuid())
  runId     String   @unique @map("run_id")
  brand     String   @default("")
  /// overall status: pending | partial | approved_all | needs_changes
  overall   String   @default("pending")
  /// JSON: Record<platform, ChannelApprovalState>
  channels  Json     @default("{}")
  /// JSON: append-only ApprovalEvent[]
  history   Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  run Run @relation(fields: [runId], references: [id])

  @@map("social_approvals")
}
