generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  editor
  viewer
}

enum RunStatus {
  draft
  running
  completed
  failed
}

enum ArtifactStatus {
  draft
  review
  approved
  published
  rejected
}

enum ApprovalDecision {
  approved
  rejected
  needs_changes
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String
  passwordHash String     @map("password_hash")
  role         Role       @default(editor)
  createdAt    DateTime   @default(now()) @map("created_at")

  runs         Run[]
  approvals    Approval[]
  publishLogs  PublishLog[]
  assets       Asset[]

  @@map("users")
}

model Workspace {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now()) @map("created_at")

  projects  Project[]

  @@map("workspaces")
}

model Project {
  id                String    @id @default(cuid())
  workspaceId       String    @map("workspace_id")
  name              String
  slug              String
  targetRegistryKey String    @map("target_registry_key")
  createdAt         DateTime  @default(now()) @map("created_at")

  workspace         Workspace @relation(fields: [workspaceId], references: [id])
  runs              Run[]
  assets            Asset[]

  @@unique([workspaceId, slug])
  @@map("projects")
}

model Run {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  workflowKey     String    @map("workflow_key")
  status          RunStatus @default(draft)
  createdByUserId String    @map("created_by_user_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  project         Project   @relation(fields: [projectId], references: [id])
  createdBy       User      @relation(fields: [createdByUserId], references: [id])
  artifacts       Artifact[]
  assets          Asset[]

  @@index([projectId])
  @@map("runs")
}

model Asset {
  id              String   @id @default(cuid())
  runId           String   @map("run_id")
  projectId       String   @map("project_id")
  filename        String
  mimeType        String   @map("mime_type")
  size            Int
  storagePath     String   @map("storage_path")
  tags            String[] @default([])
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  description     String?

  run             Run      @relation(fields: [runId], references: [id])
  project         Project  @relation(fields: [projectId], references: [id])
  createdBy       User     @relation(fields: [createdByUserId], references: [id])
  artifactAssets  ArtifactAsset[]

  @@index([runId])
  @@map("assets")
}

model Artifact {
  id        String         @id @default(cuid())
  runId     String         @map("run_id")
  type      String
  target    Json           @default("{}")
  status    ArtifactStatus @default(draft)
  title     String         @default("")
  content   String         @default("") @db.Text
  metadata  Json           @default("{}")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt     @map("updated_at")

  run             Run          @relation(fields: [runId], references: [id])
  approvals       Approval[]
  publishLogs     PublishLog[]
  artifactAssets  ArtifactAsset[]

  @@index([runId])
  @@index([type])
  @@map("artifacts")
}

model Approval {
  id         String           @id @default(cuid())
  artifactId String           @map("artifact_id")
  userId     String           @map("user_id")
  decision   ApprovalDecision
  notes      String           @default("")
  createdAt  DateTime         @default(now()) @map("created_at")

  artifact   Artifact         @relation(fields: [artifactId], references: [id])
  user       User             @relation(fields: [userId], references: [id])

  @@map("approvals")
}

model PublishLog {
  id          String   @id @default(cuid())
  artifactId  String   @map("artifact_id")
  userId      String   @map("user_id")
  destination String
  result      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  artifact    Artifact @relation(fields: [artifactId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([artifactId])
  @@map("publish_logs")
}

model ArtifactAsset {
  id         String   @id @default(cuid())
  artifactId String   @map("artifact_id")
  assetId    String   @map("asset_id")
  placement  String   @default("below")
  alignment  String?
  size       String?
  intent     String   @default("section")
  order      Int      @default(0)
  alt        String   @default("")
  caption    String?
  createdAt  DateTime @default(now()) @map("created_at")

  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, artifactId])
  @@index([artifactId])
  @@index([assetId])
  @@map("artifact_assets")
}
